## Q) 48. 웹 페이지를 어떻게 렌더링하나요?

* WebView는 앱 내에서 직접 웹 콘텐츠를 표시하고 상호 작용할 수 있는 유용한 안드로이드 컴포넌트
* 애플리케이션에 내장된 미니 브라우저 역할을 하여 개발자가 웹 페이지를 렌더링하고, HTML 콘텐츠를 로드하거나, JavaScript를 직접적으로 실행할 수 있도록 합니다.

* 앱이 실행 중인 기기에서 최신 WebView 기능을 안전하게 활용하려면 [AndroidX Webkit](https://developer.android.com/reference/androidx/webkit/package-summary) 라이브러리를 사용해야 합니다.
    * 이 라이브러리는 이전 버전과 호환되는 API를 제공하여 기기의 안드로이드 버전에 관계없이 최신 기능에 접근할 수 있도록 보장합니다.

### WebView 초기화하기

WebView를 사용하려면 레이아웃 파일에 포함하거나 코드로 직접 생성할 수 있습니다.

```xml
<!-- activity_main.xml -->
<WebView
    android:id="@+id/webView"
    android:layout_width="match_parent"
    android:layout_height="match_parent" />
```

```kotlin
val webView = WebView(this)
setContentView(webView)
```

### 웹 페이지 로드하기

웹 페이지를 로드하려면 WebView 인스턴스에서 loadUrl() 메서드를 사용합니다.
페이지가 인터넷 접근을 요구하는 경우 안드로이드 매니페스트에서 필요한 권한을 활성화해야 합니다.

```kotlin
val webView: WebView = findViewById(R.id.webView)
webView.loadUrl("https://www.example.com")
```

```xml
<uses-permission android:name="android.permission.INTERNET" />
```

### JavaScript 활성화하기

웹 콘텐츠가 JavaScript를 요구하는 경우 WebSettings를 수정하여 활성화합니다.

```kotlin
val webSettings = webView.settings
webSettings.javaScriptEnabled = true
```

### WebView 동작 커스텀하기

* **페이지 내비게이션 가로채기**: 외부 브라우저에서 열지 않고 WebView 내에서 페이지 내비게이션을 처리하려면 WebViewClient를 사용해야 합니다.

```kotlin
webView.webViewClient = object : WebViewClient() {
    // API 24 미만 버전 호환성
    override fun shouldOverrideUrlLoading(view: WebView?, url: String?): Boolean {
        url?.let { view?.loadUrl(it) }
        return true // WebView가 URL 로딩을 처리함을 나타냄
    }

    // API 24 이상 버전
    override fun shouldOverrideUrlLoading(view: WebView?, request: WebResourceRequest?): Boolean {
        request?.url?.let { view?.loadUrl(it.toString()) }
        return true
    }
}
```

* **다운로드 처리하기**: WebView를 통해 다운로드되는 파일을 관리하려면 DownloadListener를 활용할 수 있습니다.

```kotlin
webView.setDownloadListener { url, userAgent, contentDisposition, mimeType, contentLength ->
    // 여기서 파일 다운로드 처리 (예: DownloadManager 사용)
    val request = DownloadManager.Request(Uri.parse(url))
    // ... (DownloadManager 설정) ...
    val downloadManager = getSystemService(Context.DOWNLOAD_SERVICE) as DownloadManager
    downloadManager.enqueue(request)
}
```

* **WebView에서 JavaScript 실행하기**: evaluateJavascript(권장) 또는 loadUrl("javascript:...")을 사용하여 JavaScript 코드를 주입합니다.

```kotlin
// API 19 이상 권장 방식
webView.evaluateJavascript("document.body.style.backgroundColor = 'red';") { result ->
    Log.d("WebView", "JavaScript 실행 결과: $result")
}
// 이전 방식 (결과 받기 어려움)
// webView.loadUrl("javascript:document.body.style.backgroundColor = 'blue';")
```

### JavaScript를 안드로이드 코드에 바인딩하기 위한 포괄적인 가이드

- JavaScript와 안드로이드 코드를 통합하면 클라이언트 측 스크립트와 안드로이드 네이티브 기능 간의 원활한 상호 작용을 허용하여 하이브리드 웹 애플리케이션을 향상시킬 수 있습니다.
- 특히 안드로이드 앱 내 WebView에서 실행되는 웹 애플리케이션에 유용하며, JavaScript가 안드로이드 특정 기능을 활용할 수 있도록 합니다.
- 예를 들어, JavaScript의 alert() 함수에 의존하는 대신 네이티브 안드로이드 다이얼로그나 토스트 메시지를 트리거할 수 있습니다.

- 이 상호 작용을 구현하려면 addJavascriptInterface() 메서드를 사용해야 합니다.
    - 해당 메서드는 Java 객체를 WebView의 JavaScript 컨텍스트에 바인딩하여 인터페이스 이름을 지정함으로써 JavaScript를 통해 해당 메서드에 접근할 수 있도록 합니다.

```kotlin
// WebView와 통신할 인터페이스 클래스 정의
class WebAppInterface(private val context: Context) {

    // JavaScript에서 호출할 수 있도록 @JavascriptInterface 어노테이션 사용
    @JavascriptInterface
    fun showToast(message: String) {
        Toast.makeText(context, message, Toast.LENGTH_SHORT).show()
    }
}

// WebView 설정 및 인터페이스 바인딩
val webView: WebView = findViewById(R.id.webview)
webView.settings.javaScriptEnabled = true // JavaScript 활성화 필수
// "Android"라는 이름으로 인터페이스 객체 등록
webView.addJavascriptInterface(WebAppInterface(this), "Android")
```
이제 WebView에서 실행되는 JavaScript가 이 메서드를 직접적으로 호출할 수 있습니다.
아래 예제에서는 JavaScript에서 showToast 메서드를 호출하는 방법을 보여줍니다.

```html
<!DOCTYPE html>
<html>
<head>
    <title>WebView Example</title>
</head>
<body>
    <button onclick="callAndroidFunction()">Click Me</button>
    <script type="text/javascript">
        function callAndroidFunction() {
            // "Android" 인터페이스의 showToast 메서드 호출
            Android.showToast("Hello from JavaScript!");
        }
    </script>
</body>
</html>
```

버튼을 클릭하면 JavaScript 함수 callAndroidFunction()이 안드로이드 인터페이스의 showToast 메서드를 호출하여 네이티브 토스트 메시지를 표시합니다.<br>

addJavascriptInterface()는 유용하지만 한편으로 상당한 보안 위험이 따릅니다.
WebView가 신뢰할 수 없거나 동적인 HTML 콘텐츠를 로드하는 경우 공격자가 악의적인 JavaScript를 주입하여 노출된 인터페이스를 악용하고 의도하지 않은 안드로이드 코드를 잠재적으로 실행할 수 있습니다.

### 보안 고려 사항

* 보안 위험에 앱을 노출시킬 수 있으므로 필요하지 않은 한 JavaScript를 활성화하지 않는 것이 좋습니다.
* 파일에 대한 무단 접근을 방지하기 위해 setAllowFileAccess() 및 setAllowFileAccessFromFileURLs()를 신중하게 사용하는 것이 좋습니다.
* 교차 사이트 스크립팅(XSS) 또는 URL 스푸핑과 같은 공격을 방지하기 위해 항상 사용자 입력을 검증하고 URL을 정제해야 합니다.
* @JavascriptInterface를 통해 노출된 메서드가 보안 취약점을 유발하지 않는지 확인해야 합니다.

[WebView에서 웹 앱 빌드 공식문서](https://developer.android.com/develop/ui/views/layout/webapps/webview#kotlin)를 참조
